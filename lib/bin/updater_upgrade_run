#!/bin/bash

# load updater_config settings
declare -A CONFIG_ITEMS
UPDATER_CONFIG="/usr/lib/apt-notifier/bin/updater_config"
if [ -x "${UPDATER_CONFIG}" ]; then
    eval "CONFIG_ITEMS=$(${UPDATER_CONFIG} --shell)"
fi

upgrade_in_root_terminal="${CONFIG_ITEMS[upgrade_in_root_terminal]}"

check_authenticator() {
    local authenticator 
    
    # check users polkit agent is running
    if pgrep   -u $(id -u) -x  '(lx)?polkit.*' >/dev/null && \
       which pkexec > /dev/null; then
       authenticator=pkexec
    elif test -x /usr/bin/gksu; then
       authenticator=/usr/bin/gksu
    else
       # fallback to sudo
       authenticator=sudo
    fi
    echo "$authenticator"
}

# fallback to normal userterminal in case we need sudo
if [ "$upgrade_in_root_terminal" = "true" ] && \
   [ "$(check_authenticator)" = "sudo" ]; then
    upgrade_in_root_terminal="false"
fi


APT_NOTIFIERRC="/home/$(logname)/.config/apt-notifierrc"
UpgradeType=$(grep -oP '^UpgradeType=\K.*' "$APT_NOTIFIERRC" 2>/dev/null)

if [ "$(id -u)"  != "0" ]; then
	#normal user
	if [ "$upgrade_in_root_terminal" = "true" ]; then
		if [ "$UpgradeType" = "upgrade" ];   then
			RUN="/usr/lib/apt-notifier/actions/updater_basic-upgrade_action run"
		else
			RUN="/usr/lib/apt-notifier/actions/updater_full-upgrade_action run"
		fi
		$RUN
		exit $?
	fi	
else
	#root user
    #check XDG_RUNTIME_DIR
    if [ "$XDG_RUNTIME_DIR" != "/run/user/0" ]; then
		export XDG_RUNTIME_DIR=/run/user/0
		[ -d $XDG_RUNTIME_DIR ] || mkdir -p $XDG_RUNTIME_DIR
		chmod 700 $XDG_RUNTIME_DIR
		chown 0:0 $XDG_RUNTIME_DIR
    fi
    #suppress "AT-SPI: Couldn't connect to accessibility bus" warnings
    export NO_AT_BRIDGE=1
    #get QT and LANG environment from user
    for i;  do IFS='=' read  -r k v <<<$i; export $k="$v"; done

#	RUN="/usr/lib/apt-notifier/actions/updater_upgrade"
fi

# load updater shell-libs settings
UPDATER_SHLIB=/usr/lib/apt-notifier/shlib/updater_shlib
if [ -f "$UPDATER_SHLIB" ]; then
      . "$UPDATER_SHLIB"
fi

ICON="${CONFIG_ITEMS[window_icon]}"
ICON_KDE="${CONFIG_ITEMS[window_icon_KDE]}"
DOMAIN="${CONFIG_ITEMS[domain]}"
UPDATER=$(translate "MX Updater")

export TEXTDOMAIN=apt-notifier
if [ "$UpgradeType" = "upgrade" ];   then
	MSG="apt-get upgrade"
	UPGRADE=$(gettext "basic upgrade")
	RUN=/usr/lib/apt-notifier/actions/updater_basic-upgrade_action
else
	MSG="apt-get full-upgrade"
	UPGRADE=$(gettext "full upgrade")
	RUN=/usr/lib/apt-notifier/actions/updater_full-upgrade_action
fi


TITLE="${UPDATER}: $UPGRADE"
updater_show  "$MSG" "$RUN" "$TITLE" "$ICON" "$ICON_KDE"

exit
